{% extends 'base.html.twig' %}

{% block title %}Hello AccueilController!
{% endblock %}
{% block search %}
<p>recherche</p>
{% endblock %}
{% block body %}


	{% for message in app.flashes('success') %}
        <div class="alert alert-success d-flex align-items-center" role="alert">
            <i class="bi bi-check-circle me-2 text-success"></i>
            <div class="text-success">
                {{ message }}
            </div>
        </div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger d-flex align-items-center" role="alert">
            <i class="bi bi-x-circle me-2 text-danger"></i>
            <div class="text-danger">
                {{ message }}
            </div>
        </div>
    {% endfor %}

	
	{% if is_granted('ROLE_EXPERT') %}
	
	<div class="d-flex flex-column w-100 mb-5">
				{% set nbOp = 0 %}
				{% set nbOpLibre = 0 %}
				{% set nbOpReserve = 0 %}
				{% set nbOpTermine = 0 %}
				{% set CA = 0 %}

				{% for operation in operations %}
					{% set nbOp = nbOp + 1 %}
					{% if operation.statutOperation == "Libre" %}
						{% set nbOpLibre = nbOpLibre + 1 %}
					{% elseif operation.statutOperation == "En cours" %}
						{% set nbOpReserve = nbOpReserve + 1 %}
					{% elseif operation.statutOperation == "Terminée" %}
						{% set nbOpTermine = nbOpTermine + 1 %}
						{% set CA = CA + operation.typeOperation.prix %}
					{% endif %}
				{% endfor %}
		<h5 class="fw-normal mb-3">
			Statistique
		</h5>
		<div class="d-flex flex-row w-100 justify-content-between">
			<div class="rounded-custom bg-white shadow-custom text-start p-3 mr-4">

				{% if nbOp != 0 %}
					{% set PctOpLibre = nbOpLibre / nbOp * 100 %}
					{% set PctOpReserve = nbOpReserve / nbOp * 100 %}
					{% set PctOpTermine = nbOpTermine / nbOp * 100 %}
					<input type="hidden" value="{{nbOpLibre}}" id="operationsLibres"></input>
					<input type="hidden" value="{{nbOpReserve}}" id="operationsEnCours"></input>
					<input type="hidden" value="{{nbOpTermine}}" id="operationsTerminees"></input>
					<input type="hidden" value="{{nbOp}}" id="operationsTotals"></input>
				{# <p>Nombre total d'opérations : {{nbOp}}  </p>
				<p>
					Nombre d'opérations Libres : {{nbOpLibre}} --> {{PctOpLibre|number_format(2, '.', ',')}}% 
				</p>
				<p>Nombre d'opération réservées : {{nbOpReserve}} --> {{PctOpReserve|number_format(2, '.', ',')}}%</p>
				<p>Nombre d'opération terminées : {{nbOpTermine}} --> {{PctOpTermine|number_format(2, '.', ',')}}%</p>
				<p>Chiffre d'Affaire (opérations terminées) :  {{CA|number_format(0, '.', ',')}}€</p> #}
				<p>Opération</p>
				<div id="chartdiv" style="width: 500px; min-height: 300px;"></div>
				{% else %}
				<p>Il n'y a pas d'opérations</p>
				{% endif %}
				

				
				
			</div>
			<div class="rounded-custom bg-white shadow-custom text-start p-3 w-100">
				<p>Chiffre d'affaire</p>
				<div class="w-100 h-100 d-flex justify-content-center align-items-center">
					<h6 style="font-size: 100px">{{CA|number_format(0, '.', ',')}}€</h6>
				</div>

			</div>
		</div>
	</div>

	<div class="d-flex flex-column w-100 mb-5">
		<h5 class="fw-normal mb-3">
			Liste des Utilisateurs
		</h5>
		<div class="table-responsive rounded-custom bg-white shadow-custom text-center">
			<table class="table table-hover table-borderless text-dark">
				<thead >
					<tr>
						<th scope="col" style="width: 54px;">Id</th>
						<th scope="col" style="width: 90px;">Photo</th>
						<th scope="col">Rôle</th>
						<th scope="col">Nom</th>
						<th scope="col">Prénom</th>
						<th scope="col">Téléphone</th>
						<th scope="col">Adresse</th>
						<th scope="col">Mail</th>
						<th scope="col" style="width: 90px;">Actions</th>
					</tr>
					<tr>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col">
							<button type="button" class="btn nimi-btn bg-primary p-1 rounded-custom text-primary bg-opacity-10" data-bs-toggle="modal" data-bs-target="#utilisateurAjout">
								<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
									<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
								</svg>
                            </button>
						</th>

						<!-- Modal -->
						<div class="modal fade" id="utilisateurAjout" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
							<div class="modal-dialog modal-dialog-centered modal-lg">
								<div class="modal-content border-0 rounded-custom shadow-modal p-3">
									<div class="modal-header d-flex flex-row justify-content-between align-items-start border-0">
									<h3>Création d'un nouvel utilisateur</h3>
										<div class="d-flex flex-row align-items-start h-100">
											<button type="button" class="btn nimi-btn bg-danger p-1 rounded-custom text-danger bg-opacity-10" data-bs-dismiss="modal" aria-label="Close">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
													<path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
												</svg>
											</button>
										</div>
									</div>
									<div class="modal-body d-flex justify-content-between text-start flex-column w-100 p-4">
											{{ include('registration/register.html.twig', {'button_label': 'Créer'}) }}
									</div>
								</div>
							</div>
						</div>
					</tr>
				</thead>
				<tbody>
				{% for utilisateur in utilisateurs %}
					<tr class="align-middle">
						<td scope="row">#{{ utilisateur.id }}</td>
						<td><img src="https://avatars.dicebear.com/api/identicon/{{ utilisateur.nom }}.{{ utilisateur.prenom }}.svg" height="32" width="32" alt="..." class="border border-secondary border-2 rounded-custom bg-light"></td>
						{% for role in utilisateur.roles %}
						{% if role =='ROLE_APPRENTI' %}
						<td>Apprenti</td>	
						{% elseif role =='ROLE_SENIOR' %}
						<td>Senior</td>	
						{% else %}	
						<td>Expert</td>		 
						{% endif %}
						{% endfor %}
						<td>{{ utilisateur.nom }}</td>
						<td>{{ utilisateur.prenom }}</td>
						<td>{{ utilisateur.telephone }}</td>
						<td>{{ utilisateur.adresse }}</td>
						<td>{{ utilisateur.email }}</td>
						<td class="d-flex flex-row justify-content-evenly w-100">
							<button onclick="window.location.href='{{ path('utilisateur_edit', {'id': utilisateur.id}) }}';" class="btn nimi-btn bg-info p-1 rounded-custom text-info bg-opacity-10">
								<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pen-fill" viewBox="0 0 16 16">
									<path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001z"/>
								</svg>
							</button>
							{{ include('utilisateur/_delete_form.html.twig', {'_url': 'accueil'}) }}</td>
					</tr>
				{% endfor %}
				</tbody>
			</table>
		</div>
	</div>

	<div class="d-flex flex-column w-100mb-5">
		<h5 class="fw-normal mb-3">
			Liste des Clients
		</h5>
        <div class="table-responsive rounded-custom bg-white shadow-custom text-center">
			
			<table class="table table-hover table-borderless text-dark">
				<thead >
					<tr>
						<th scope="col" style="width: 54px;">Id</th>
						<th scope="col" style="width: 90px;">Photo</th>
						<th scope="col">Nom</th>
						<th scope="col">Prénom</th>
						<th scope="col">Téléphone</th>
						<th scope="col">Adresse</th>
						<th scope="col">Mail</th>
						<th scope="col" style="width: 90px;">Actions</th>
					</tr>
					<tr>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col" class="opacity-25">#</th>
						<th scope="col"><button type="button" class="btn mini-btn bg-primary p-1 rounded-custom text-primary bg-opacity-10" data-bs-toggle="modal" data-bs-target="#clientAjout">
										<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
										<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
										</svg>
                                		</button></th>
						
							<!-- Modal -->
						<div class="modal fade" id="clientAjout" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
							<div class="modal-dialog modal-dialog-centered modal-lg">
								<div class="modal-content border-0 rounded-custom shadow-modal p-3">
									<div class="modal-header d-flex flex-row justify-content-between align-items-start border-0">
									<h3>Création d'un nouveau client</h3>
										<div class="d-flex flex-row align-items-start h-100">
											<button type="button" class="btn nimi-btn bg-danger p-1 rounded-custom text-danger bg-opacity-10" data-bs-dismiss="modal" aria-label="Close">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
													<path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
												</svg>
											</button>
										</div>
									</div>
									<div class="modal-body d-flex justify-content-between text-start flex-column w-100 p-4">
											{{ include('client/_form.html.twig', {'button_label': 'Créer'}) }}
									</div>
								</div>
							</d
					</tr>
				</thead>
				<tbody>
				{% for client in clients %}
					<tr class="align-middle">
						<td scope="row">#{{ client.id }}</td>
						<td><img src="https://avatars.dicebear.com/api/identicon/{{ client.nom }}.{{ client.prenom }}.svg" height="32" width="32" alt="..." class="border border-secondary border-2 rounded-custom bg-light"></td>
						<td>{{ client.nom }}</td>
						<td>{{ client.prenom }}</td>
						<td>{{ client.telephone }}</td>
						<td>{{ client.adresse }}</td>
						<td>{{ client.mail }}</td>
						<td class="d-flex flex-row justify-content-evenly w-100">
							<button onclick="window.location.href='{{ path('client_edit', {'id': client.id}) }}';" class="btn nimi-btn bg-info p-1 rounded-custom text-info bg-opacity-10">
								<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-pen-fill" viewBox="0 0 16 16">
									<path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001z"/>
								</svg>
							</button>
							{{ include('client/_delete_form.html.twig', {'_url': 'accueil'}) }}
						</td>
					</tr>
				{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
	{% endif %}
{% endblock %}
{% block javascripts %}
	{{ parent() }}

	<!-- Resources -->
	<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
	<script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
	<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
	<script src="https://cdn.amcharts.com/lib/5/themes/Responsive.js"></script>

	<!-- Chart code -->
	<script>

	am5.ready(function() {

	// Create root element
	// https://www.amcharts.com/docs/v5/getting-started/#Root_element
	var root = am5.Root.new("chartdiv");

	// Set themes
	// https://www.amcharts.com/docs/v5/concepts/themes/
	root.setThemes([
		am5themes_Animated.new(root),
		am5themes_Responsive.new(root)
	]);

	// Create chart
	// https://www.amcharts.com/docs/v5/charts/percent-charts/pie-chart/
	// start and end angle must be set both for chart and series
	var chart = root.container.children.push(
		am5percent.PieChart.new(root, {
			layout: root.verticalLayout,
			radius: am5.percent(80),
			innerRadius: am5.percent(70)
		})
	);

	var label = chart.seriesContainer.children.push(
		am5.Label.new(root, {
			textAlign: "center",
			centerY: am5.p50,
			centerX: am5.p50,
			fill: am5.color(0x022C43),
			text: "[fontSize:18px]total[/]:\n[bold fontSize:30px]"+document.getElementById('operationsTotals').value+"[/]"
		})
	);

	// Define data
	var data = [{
		category: "Libres",
		value: document.getElementById('operationsLibres').value,
		sliceSettings: { fill: am5.color(0x00B2FF) }
	}, {
		category: "En cours",
		value: document.getElementById('operationsEnCours').value,
		sliceSettings: { fill: am5.color(0xFFC700) }
	}, {
		category: "Terminées",
		value: document.getElementById('operationsTerminees').value,
		sliceSettings: { fill: am5.color(0x20D489) }
	}];

	// Create series
	var series = chart.series.push(
		am5percent.PieSeries.new(root, {
			name: "Series",
			valueField: "value",
			categoryField: "category",
			legendLabelText: "{category}",
			alignLabels: false
		})
	);

	series.slices.template.setAll({
		templateField: "sliceSettings",
		strokeOpacity: 0
	});

	series.data.setAll(data);
	series.labels.template.setAll({
		fontSize: 18,
		text: "[bold]{value}[/]",
		textType: "circular",
		inside: true,
		radius: 7,
		fill: am5.color(0x022C43)
	})

	// Create legend
	var legend = chart.children.push(am5.Legend.new(root, {
		textAlign: "center",
		centerX: am5.percent(50),
		x: am5.percent(50),
		marginTop: 10,
		marginBottom: 30,
		
	}));
	// Disabling labels and ticks
	series.labels.template.set("visible", true);
	series.ticks.template.set("visible", true);
	legend.data.setAll(series.dataItems);

	}); // end am5.ready()
</script>
{% endblock %}